<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="CMS003w_01DAO">

	<resultMap id="boardMap" type="java.util.Map"> 
		<result property="CONTENT" column="CONTENT" javaType="java.lang.String" jdbcType="CLOB" typeHandler="org.apache.ibatis.type.ClobTypeHandler" /> 
	</resultMap>
	
	<select id="SELECT_REC_CMS_PAYMENT_MGT" parameterType="kr.co.o2i.util.CommonMap" resultMap="boardMap">
		SELECT
			REQ.TEMPLE_CD,
			REQ.IF_REQUEST_DATE,
			REQ.IF_TRAN_ID,
			REQ.IF_MEMBER_ID,
			SCI.IF_PAYMENT_BANK_CD AS BANK_CD,
			ACM_BANK.NAME AS BANK_NM,
			SCI.IF_PAYMENT_ACCOUNT AS ACCOUNT_NO,
			SCI.ACCOUNT_SEQ AS ACCOUNT_SEQ,  
			REQ.REQUEST_SEQ,
			REQ.IF_SEQ,
			REQ.IF_REAL_PAYMENT_DATE,
			REQ.IF_PAYMENT_COMPLETION_AMOUNT,
			REQ.IF_PAYMENT_COMMISSION,
			REQ.IF_PROCESS_RESULT,
			ACM_PRO.NAME AS IF_PROCESS_RESULT_NM,
			REQ.REQEUST_FEE,
			REQ.IF_RESULT_CD,
			REQ.IF_RESULT_MESSAGE,
			REQ.IF_TRANSFER_DATE,
			REQ.IF_RECEIPT_DATE,
			REQ.CMS_REQUEST_GBN,
			REQ.PAYMENT_YYYYMMDD,
			REQ.IF_REQUEST_PAYMENT_AMOUNT,
			REQ.SEND_YN,
			REQ.RECEIVE_YN,
			REQ.AMOUNT_STATUS,
			SIN.BUD_NO,
			SIN.NAME_KOR,
			SIN.TELNO1 || '-' || SIN.TELNO2 || '-' || SIN.TELNO3 AS TEL_NO,
			SIN.MOBILE_TELNO1 || '-' || SIN.MOBILE_TELNO2 || '-' || SIN.MOBILE_TELNO3 AS MOBILE_TEL_NO
		FROM
		(
			SELECT
				INF.TEMPLE_CD,
				IF_REQUEST_DATE,
				IF_TRAN_ID,
				IF_MEMBER_ID,
				SUBSTR(IF_MEMBER_ID,1,3) AS BANK_CD,
				SUBSTR(IF_MEMBER_ID,4,LENGTH(IF_MEMBER_ID)-5) AS ACCOUNT_NO,
				TO_NUMBER(SUBSTR(IF_MEMBER_ID,LENGTH(IF_MEMBER_ID)-1)) AS ACCOUNT_SEQ,
				REQUEST_SEQ,
				IF_SEQ,
				IF_REAL_PAYMENT_DATE,
				IF_PAYMENT_COMPLETION_AMOUNT,
				IF_PAYMENT_COMMISSION,
				IF_PROCESS_RESULT,
				DECODE(CPM.IF_PROCESS_RESULT,'Y',IF_PAYMENT_COMMISSION,'N',IF_PAYMENT_COMMISSION,0) AS REQEUST_FEE,
				IF_RESULT_CD,
				DECODE(AMOUNT_STATUS,'1',DECODE(IF_RESULT_MESSAGE,NULL,'처리중',IF_RESULT_MESSAGE),'한도초과') AS IF_RESULT_MESSAGE,
				TO_CHAR(IF_TRANSFER_DATE,'YYYYMMDD') AS IF_TRANSFER_DATE,
				TO_CHAR(IF_RECEIPT_DATE,'YYYYMMDD') AS IF_RECEIPT_DATE,
				CMS_REQUEST_GBN,
				PAYMENT_YYYYMMDD,
				IF_REQUEST_PAYMENT_AMOUNT,
				SEND_YN,
				RECEIVE_YN,
				AMOUNT_STATUS
			FROM ASP_TEMPLE_CMS_INFO INF,
				 REC_CMS_PAYMENT_MGT CPM
			WHERE 1=1
			AND INF.CMS_TRADE_CD = CPM.IF_TRAN_ID
			AND INF.TEMPLE_CD = '${V_TEMPLE_CD}'
			<if test='V_CMS_TRADE_CD != nul and  V_CMS_TRADE_CD != "" '>
				AND INF.CMS_TRADE_CD = '${V_CMS_TRADE_CD}'
			</if>
			AND IF_REQUEST_DATE BETWEEN '${V_SDATE}' AND '${V_EDATE}'
		) REQ,
			SIN_CMS_INFO SCI,
		    SIN_CARD_MASTER SIN,
		    ASP_CODE_MGT ACM_BANK,
		    ASP_CODE_MGT ACM_PRO
		WHERE 1=1
		AND REQ.TEMPLE_CD            = SCI.TEMPLE_CD
		AND REQ.IF_MEMBER_ID         = SCI.IF_MEMBER_ID
		AND REQ.TEMPLE_CD            = SIN.TEMPLE_CD
		AND SCI.BUD_NO               = SIN.BUD_NO
		AND ACM_BANK.GROUP_CD        = 'BANK'
		AND SCI.IF_PAYMENT_BANK_CD   = ACM_BANK.CODE
		AND ACM_PRO.GROUP_CD(+)      = 'USE_YN'
		AND REQ.IF_PROCESS_RESULT    = ACM_PRO.CODE(+)
		<if test='V_BUD_NO != nul and  V_BUD_NO != "" '>
			AND SIN.BUD_NO = '${V_BUD_NO}'
		</if>
		ORDER BY IF_REQUEST_DATE, IF_TRAN_ID, IF_SEQ
	</select>

	<select id="SELECT_REC_CMS_PAYMENT_DETAIL" parameterType="kr.co.o2i.util.CommonMap" resultMap="boardMap">
		SELECT T1.* 
			  ,FN_GET_REMARK(#{V_TEMPLE_CD} ,T1.ACCEPT_SEQ, T1.ACCEPT_GBN , T1.SEQ) AS REMARK
		 FROM (
				SELECT IF_REQUEST_DATE
				      ,IF_TRAN_ID
				      ,IF_MEMBER_ID
				      ,REQUEST_SEQ
				      ,ACCEPT_SEQ
				      ,SEQ
				      ,PAYMENT_YYYYMM
				      ,AMOUNT
				      ,(SELECT ACCEPT_GBN 
				          FROM REC_SUB 
				         WHERE TEMPLE_CD  = #{V_TEMPLE_CD} 
				           AND ACCEPT_SEQ = DET.ACCEPT_SEQ 
				           AND SEQ        = DET.SEQ 
				        ) AS ACCEPT_GBN,
				     FN_GET_REC_NM(#{V_TEMPLE_CD}, DET.ACCEPT_SEQ, DET.SEQ) AS REC_NM
				 FROM REC_CMS_PAYMENT_DETAIL DET
				WHERE IF_TRAN_ID      = #{V_IF_TRAN_ID}
				  AND IF_REQUEST_DATE = #{V_IF_REQUEST_DATE}
				  AND IF_MEMBER_ID    = #{V_IF_MEMBER_ID}
				  AND REQUEST_SEQ     = #{V_REQUEST_SEQ}
				ORDER BY ACCEPT_SEQ, SEQ
	      ) T1
	</select>
	
	
	<select id="SELECT_REC_CMS_TOT" parameterType="kr.co.o2i.util.CommonMap" resultMap="boardMap">
		SELECT SCI.REG_GBN AS CCNT
			  ,count(1) PCNT
			  ,sum(IF_REQUEST_PAYMENT_AMOUNT)  CTOTAL
			  ,sum(IF_REQUEST_PAYMENT_AMOUNT)  PTOTAL
			  ,#{V_TEMPLE_CD} AS TEMPLE_CD
		  FROM (
					SELECT		
						IF_TRAN_ID,
						IF_MEMBER_ID,		
						IF_REQUEST_PAYMENT_AMOUNT,
				    INF.TEMPLE_CD
					FROM ASP_TEMPLE_CMS_INFO INF,
						   REC_CMS_PAYMENT_MGT CPM
					WHERE 1=1
					AND INF.CMS_TRADE_CD = CPM.IF_TRAN_ID
					AND INF.TEMPLE_CD     = #{V_TEMPLE_CD}
					AND IF_REQUEST_DATE BETWEEN #{V_SDATE} AND #{V_EDATE}
				    AND IF_PROCESS_RESULT = 'Y'
		        ) REQ
		       , SIN_CMS_INFO SCI
		WHERE 1=1
		AND REQ.TEMPLE_CD         = SCI.TEMPLE_CD
		AND REQ.IF_MEMBER_ID      = SCI.IF_MEMBER_ID
		GROUP by REG_GBN
	</select>
	
</mapper>